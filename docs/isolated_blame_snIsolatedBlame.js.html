<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>isolated/blame/snIsolatedBlame.js - SN Blame</title>

    <meta
      name="description"
      content="ServiceNow Browser Extensions utility tool"
    />

    <meta name="keywords" content="ServiceNow" />
    <meta name="keyword" content="ServiceNow" />

    <meta property="og:title" content="SN Blame" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="" />
    <meta property="og:site_name" content="SN Blame" />
    <meta property="og:url" content="" />

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css" />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css" />
    <script src="scripts/nav.js" defer></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <input type="checkbox" id="nav-trigger" class="nav-trigger" />
    <label for="nav-trigger" class="navicon-button x">
      <div class="navicon"></div>
    </label>

    <label for="nav-trigger" class="overlay"></label>

    <nav>
      <input type="text" id="nav-search" placeholder="Search" />

      <h2><a href="index.html">Home</a></h2>
      <h2>
        <a
          href="https://github.com/amagnin/SNBlameExtension"
          target="_blank"
          class="menu-item"
          id="repository"
          >Github repo</a
        >
      </h2>
      <h3>Classes</h3>
      <ul>
        <li>
          <a href="StaticCodeAnalisisUtil.html">StaticCodeAnalisisUtil</a>
          <ul class="methods">
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#updateScriptIncludeMap"
                >updateScriptIncludeMap</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#getScriptIncludeSysID"
                >getScriptIncludeSysID</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#getLoadedLibraries"
                >getLoadedLibraries</a
              >
            </li>
            <li data-type="method">
              <a
                href="StaticCodeAnalisisUtil.html#runScriptIncludesCodeAnalisis"
                >runScriptIncludesCodeAnalisis</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#runScriptAnalisis"
                >runScriptAnalisis</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#findScriptIncludeCall"
                >findScriptIncludeCall</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#setAvailableSNScopes"
                >setAvailableSNScopes</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#getAvailableSNScopes"
                >getAvailableSNScopes</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#getScopeFromID"
                >getScopeFromID</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#triggerScriptIncludeLib"
                >triggerScriptIncludeLib</a
              >
            </li>
          </ul>
        </li>
        <li>
          <a href="MonacoBlameColorMap.html">MonacoBlameColorMap</a>
          <ul class="methods">
            <li data-type="method">
              <a href="MonacoBlameColorMap.html#getColor">getColor</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="MonacoBlameGutter.html">MonacoBlameGutter</a>
          <ul class="methods">
            <li data-type="method">
              <a href="MonacoBlameGutter.html#createGutter">createGutter</a>
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutter.html#updateLines">updateLines</a>
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutter.html#updateGutterSize"
                >updateGutterSize</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutter.html#updateGutter">updateGutter</a>
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutter.html#destroyGutter">destroyGutter</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="MonacoBlameGutterWrapper.html">MonacoBlameGutterWrapper</a>
          <ul class="methods">
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#createGutter"
                >createGutter</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#updateGutter"
                >updateGutter</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#updateGutterLines"
                >updateGutterLines</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#updateGutterSize"
                >updateGutterSize</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#destroyGutter"
                >destroyGutter</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#updateGutterOptions"
                >updateGutterOptions</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#gutterExists"
                >gutterExists</a
              >
            </li>
          </ul>
        </li>
        <li>
          <a href="CacheManager.html">CacheManager</a>
          <ul class="methods">
            <li data-type="method">
              <a href="CacheManager.html#conectDB">conectDB</a>
            </li>
            <li data-type="method">
              <a href="CacheManager.html#getAllBlameCacheKeys"
                >getAllBlameCacheKeys</a
              >
            </li>
            <li data-type="method">
              <a href="CacheManager.html#invalidateScriptIncludeCache"
                >invalidateScriptIncludeCache</a
              >
            </li>
            <li data-type="method">
              <a href="CacheManager.html#getScriptIncludeCache"
                >getScriptIncludeCache</a
              >
            </li>
            <li data-type="method">
              <a href="CacheManager.html#setScriptIncludeCache"
                >setScriptIncludeCache</a
              >
            </li>
            <li data-type="method">
              <a href="CacheManager.html#clearScriptIncludeCache"
                >clearScriptIncludeCache</a
              >
            </li>
            <li data-type="method">
              <a href="CacheManager.html#validateScriptIncludeCache"
                >validateScriptIncludeCache</a
              >
            </li>
            <li data-type="method">
              <a href="CacheManager.html#.getCache">getCache</a>
            </li>
            <li data-type="method">
              <a href="CacheManager.html#.setCache">setCache</a>
            </li>
            <li data-type="method">
              <a href="CacheManager.html#.invalidateCache">invalidateCache</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="SNBlameOptions.html">SNBlameOptions</a>
          <ul class="methods">
            <li data-type="method">
              <a href="SNBlameOptions.html#reloadOptions">reloadOptions</a>
            </li>
            <li data-type="method">
              <a href="SNBlameOptions.html#getOption">getOption</a>
            </li>
            <li data-type="method">
              <a href="SNBlameOptions.html#setOption">setOption</a>
            </li>
            <li data-type="method">
              <a href="SNBlameOptions.html#getAllOptions">getAllOptions</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="snRESTFactory.html">snRESTFactory</a>
          <ul class="methods">
            <li data-type="method">
              <a href="snRESTFactory.html#~getVersions">getVersions</a>
            </li>
            <li data-type="method">
              <a href="snRESTFactory.html#~getScriptIncludes"
                >getScriptIncludes</a
              >
            </li>
            <li data-type="method">
              <a href="snRESTFactory.html#~getRecords">getRecords</a>
            </li>
            <li data-type="method">
              <a href="snRESTFactory.html#~getScope">getScope</a>
            </li>
            <li data-type="method">
              <a href="snRESTFactory.html#~getProperties">getProperties</a>
            </li>
            <li data-type="method">
              <a href="snRESTFactory.html#~getScriptIncludeCache"
                >getScriptIncludeCache</a
              >
            </li>
          </ul>
        </li>
        <li>
          <a href="SNBlameDateUtils.html">SNBlameDateUtils</a>
          <ul class="methods">
            <li data-type="method">
              <a href="SNBlameDateUtils.html#.getFormattedDate"
                >getFormattedDate</a
              >
            </li>
            <li data-type="method">
              <a href="SNBlameDateUtils.html#.timeAgo">timeAgo</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="SNBlamePlaceholderContentWidget.html"
            >SNBlamePlaceholderContentWidget</a
          >
          <ul class="methods">
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#updateDiff"
                >updateDiff</a
              >
            </li>
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#onCursorChange"
                >onCursorChange</a
              >
            </li>
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#getId">getId</a>
            </li>
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#getDomNode"
                >getDomNode</a
              >
            </li>
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#getPosition"
                >getPosition</a
              >
            </li>
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#dispose">dispose</a>
            </li>
          </ul>
        </li>
      </ul>
      <h3>Modules</h3>
      <ul>
        <li>
          <a href="module-scriptIncludesStaticCodeAnalysis.html"
            >scriptIncludesStaticCodeAnalysis</a
          >
          <ul class="methods">
            <li data-type="method">
              <a
                href="module-scriptIncludesStaticCodeAnalysis.html#~methodWalker"
                >methodWalker</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-scriptIncludesStaticCodeAnalysis.html#~getES6ClassMethods"
                >getES6ClassMethods</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-scriptIncludesStaticCodeAnalysis.html#~getSNClassMethods"
                >getSNClassMethods</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-scriptIncludesStaticCodeAnalysis.html#~getTableName"
                >getTableName</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-scriptIncludesStaticCodeAnalysis.html#~runScriptIncludeCodeParsing"
                >runScriptIncludeCodeParsing</a
              >
            </li>
          </ul>
        </li>
        <li>
          <a href="module-scriptIncludesToExtraLib.html"
            >scriptIncludesToExtraLib</a
          >
          <ul class="methods">
            <li data-type="method">
              <a
                href="module-scriptIncludesToExtraLib.html#~getScriptIncludeLib"
                >getScriptIncludeLib</a
              >
            </li>
          </ul>
        </li>
        <li>
          <a href="module-walkerFunctions.html">walkerFunctions</a>
          <ul class="methods">
            <li data-type="method">
              <a href="module-walkerFunctions.html#~isGlideRecordNext"
                >isGlideRecordNext</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-walkerFunctions.html#~getConstructorContextExpresions"
                >getConstructorContextExpresions</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-walkerFunctions.html#~getGlideRecordFromDeclaration"
                >getGlideRecordFromDeclaration</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-walkerFunctions.html#~getGlideRecordFromAssignment"
                >getGlideRecordFromAssignment</a
              >
            </li>
            <li data-type="method">
              <a href="module-walkerFunctions.html#~checkNestedWhileRecord"
                >checkNestedWhileRecord</a
              >
            </li>
            <li data-type="method">
              <a href="module-walkerFunctions.html#~removeParentesis"
                >removeParentesis</a
              >
            </li>
          </ul>
        </li>
        <li><a href="module-SNBlameMain.html">SNBlameMain</a></li>
        <li>
          <a href="module-snIsolatedListHelper.html">snIsolatedListHelper</a>
          <ul class="methods">
            <li data-type="method">
              <a href="module-snIsolatedListHelper.html#~getListData"
                >getListData</a
              >
            </li>
          </ul>
        </li>
      </ul>
      <h3>Events</h3>
      <ul>
        <li>
          <a href="module-SNBlameMain.html#~event:sn-list-helper-response"
            >sn-list-helper-response</a
          >
        </li>
        <li>
          <a href="module-SNBlameMain.html#~event:sn-blame-start"
            >sn-blame-start</a
          >
        </li>
        <li>
          <a href="module-SNBlameMain.html#~event:sn-list-helper-start"
            >sn-list-helper-start</a
          >
        </li>
        <li>
          <a href="module-SNBlameMain.html#~event:sn-blame-option-update"
            >sn-blame-option-update</a
          >
        </li>
      </ul>
      <h3>Global</h3>
      <ul>
        <li><a href="global.html#snVersions">snVersions</a></li>
        <li><a href="global.html#BlameLine">BlameLine</a></li>
        <li><a href="global.html#restFactory">restFactory</a></li>
        <li>
          <a href="global.html#staticCodeAnalisisUtil"
            >staticCodeAnalisisUtil</a
          >
        </li>
        <li><a href="global.html#parsedScript">parsedScript</a></li>
        <li>
          <a href="global.html#parsedScriptIncludes">parsedScriptIncludes</a>
        </li>
        <li>
          <a href="global.html#parsedScriptInclude">parsedScriptInclude</a>
        </li>
        <li><a href="global.html#BlameOptions">BlameOptions</a></li>
        <li>
          <a href="global.html#ServiceNowRESTFactory">ServiceNowRESTFactory</a>
        </li>
        <li><a href="global.html#MonacoEditor">MonacoEditor</a></li>
        <li>
          <a href="global.html#snBlameRecordWatcher">snBlameRecordWatcher</a>
        </li>
      </ul>
    </nav>

    <div id="main">
      <h1 class="page-title">isolated/blame/snIsolatedBlame.js</h1>

      <section>
        <article>
          <pre
            class="prettyprint source linenums"
          ><code>import MonacoBlameGutterWrapper from "./MonacoBlameGutterWrapper.js";
import SNBlameOptions from "../SNBlameOptions.js";
import snRESTFactory from "../snRESTFactory.js";

import StaticCodeAnalisisUtil from "../../astParser/staticCodeAnalysisUtil.js";

import patienceDiff from "../../../libraries/patienceDiff.js";
import X2JS from "x2js";

export default function () {
  /**@typedef {import('../snRESTFactory.js').ServiceNowRESTFactory} ServiceNowRESTFactory */
  /**@typedef {import('../isolatedMain.js').BlameLine} BlameLine */

  /** @type {Object} */
  let serverDiff = {};
  /** @type {boolean} */
  let loaded = false;

  /** @type {ServiceNowRESTFactory} */
  let restFactory;

  /** @type {StaticCodeAnalisisUtil}*/
  let staticCodeAnalisisUtil;

  /**
   * @type {Object}
   * @property sn-blame-init {function}
   * @property sn-blame-model-change {function}
   * @property sn-check-tokens {function}
   * @property sn-get-scirpt_include_cache {function}
   */
  const LISTENERS = {
    "sn-blame-init": (event) => {
      const { g_ck, table, sys_id, fields } = event.detail;
      restFactory = snRESTFactory(g_ck);

      window.dispatchEvent(
        new CustomEvent("sn-get-scirpt_include_cache", {
          detail: {
            g_ck,
          },
        })
      );

      const ignoreTableList = new SNBlameOptions().getOption("ignoreTableList");
      if (ignoreTableList.indexOf(table) !== -1) return;

      getVersions(table, sys_id, Object.keys(fields)).then((versions) => {
        if (loaded === true) return;

        Object.keys(fields).forEach((field) => {
          let editorElement = document.querySelector(
            `[id='element.${fields[field].id}'] #debugContainer`
          );
          loaded = true;

          if (versions.length === 0) {
            let warnDiv = document.createElement("DIV");
            warnDiv.innerText =
              "SN BLAME: NO VERSIONS AVAILABLE, CAN'T START BLAME";
            warnDiv.style.padding = "10px";
            warnDiv.style.backgroundColor = "hsl(55deg 100% 12%)";
            warnDiv.style.margin = "10px";
            warnDiv.style.color = "white";
            warnDiv.style.fontWeight = "bold";

            editorElement.prepend(warnDiv);
            return;
          }

          const ignoreWhiteSpace = new SNBlameOptions().getOption(
            "ignoreWhiteSpace"
          );
          serverDiff[field] = getBlame(versions, field, ignoreWhiteSpace);
          let currentDiff = getDiffsWithCurrent(
            fields[field].lines,
            serverDiff[field],
            ignoreWhiteSpace
          );
          window.dispatchEvent(
            new CustomEvent("sn-blame-diff-update", {
              detail: { diff: currentDiff, field },
            })
          );

          const gutters = new MonacoBlameGutterWrapper();

          gutters.createGutter(field, editorElement, currentDiff);
          window.dispatchEvent(
            new CustomEvent("sn-blame-get-scroll-position", {
              detail: { field },
            })
          );
        });
      });
    },
    "sn-blame-model-change": (event) => {
      const { script, field } = event.detail;
      const lines = script.split("\n");

      const gutters = new MonacoBlameGutterWrapper();
      if (!gutters.gutterExists(field)) return;

      const ignoreWhiteSpace = new SNBlameOptions().getOption(
        "ignoreWhiteSpace"
      );
      const currentDiff = getDiffsWithCurrent(
        lines,
        serverDiff[field],
        ignoreWhiteSpace
      );

      window.dispatchEvent(
        new CustomEvent("sn-blame-diff-update", {
          detail: { diff: currentDiff, field },
        })
      );
      gutters.updateGutterLines(field, currentDiff);
    },
    "sn-check-lines": (event) => {
      const { lines, field, currentScope } = event.detail;

      lines.forEach((line) => {
        findScriptIncludeCall(line, currentScope);
      });
    },
    "sn-get-scirpt_include_cache": (event) => {
      if (typeof restFactory?.getScriptIncludeCache !== "function") {
        restFactory = snRESTFactory(event.detail.g_ck);
      }

      restFactory.getScriptIncludeCache().then((cache) => {
        staticCodeAnalisisUtil = new StaticCodeAnalisisUtil(cache);

        window.dispatchEvent(
          new CustomEvent("sn-blame-trigger-full-script-intelisense")
        );
      });
    },
    "sn-check-full-script": (event) => {
      const { script, currentScope } = event.detail;

      findScriptIncludeCall(script, currentScope);
    },
  };

  Object.keys(LISTENERS).forEach((key) => {
    window.addEventListener(key, LISTENERS[key]);
  });

  /**
   * Calls snRESTFactory getVersions to retrive all versions form the given record
   *
   * @param {string} table record table name
   * @param {string} sys_id record unique id (sys_id)
   * @param {Array&lt;string>} scriptFields list of fields that renders using the monaco editor usualy fields of type script present on the form
   * @returns {Array&lt;snVersions>}
   */
  async function getVersions(table, sys_id, scriptFields) {
    var parser = new X2JS();

    let body = await restFactory.getVersions(table, sys_id);
    if (!body) return;

    let result = body.result.map((b) => {
      let record = parser.xml2js(b.payload.value).record_update[table];
      let res = {};
      scriptFields.forEach((field) => {
        res[field] = record[field].split("\n");
      });
      res.sys_updated_by = record.sys_updated_by;
      res.sys_updated_on = record.sys_updated_on;
      res.sys_recorded_at = b.sys_recorded_at.value;
      res.reverted_from = b.reverted_from.value;
      res.sys_id = b.sys_id.value;
      res.state = b.state.value;
      res.source = b.source;

      return res;
    });

    /**
     * @typedef snVersions
     * @type {Object}
     *
     * @property sys_updated_by {string} timestap last updated time usualy same as created time
     * @property sys_updated_on {string} timestap last updated time
     * @property sys_recorded_at {string} unix timestamp in HEX when the version was created
     * @property reverted_from {string} if the version was reverted sys_id of the version reverted to
     * @property sys_id {string} unique identifier of the version
     * @property state {string} state of the version current|previous|reverted
     * @property source {string} sys_id of the source (update set or patch)
     */

    return removeReverted(
      result.sort(function (a, b) {
        return (
          Number("0x" + b.sys_recorded_at) - Number("0x" + a.sys_recorded_at)
        );
      })
    );
  }

  /**
   * removes the irelevant versions for the version list, Versions that don't apply to the bale due to being reverted to a previous update
   *
   * @param {Array&lt;snVersions>} versions List of servicenow record versions
   * @returns {snVersions} list of versions with out the versions to ignore due to revert actions
   */
  function removeReverted(versions) {
    var result = [];
    var next = null;

    versions.forEach(function (element) {
      if (next == null || next === element.sys_id) {
        result.push(element);
        next = element.reverted_from || null;
        return;
      }
    });

    return result.reverse();
  }

  /**
   * Generates the balme for the given version/field combo
   *
   * @param {Array&lt;snVersions>} versions list of versions to generate the blame from
   * @param {string} key fieldname for the blame
   * @param {boolean} ignoreWhiteSpace if true will ignore whitespaces when comparing lines
   * @returns {Array&lt;BlameLine>} Array of lines with the infromation of the last user/update set/patch who changed the line
   */
  function getBlame(versions, key, ignoreWhiteSpace) {
    if (versions.length === 0) return [];

    const initialVersion = versions[0];

    var result = initialVersion[key].map(function (line, index) {
      return {
        index: index,
        line: ignoreWhiteSpace ? line.replace(/\s\s+/g, " ").trim() : line,
        author: versions[0].sys_updated_by,
        versionID: versions[0].sys_id,
        source: versions[0].source,
        date: versions[0].sys_updated_on,
      };
    });

    for (let i = 1; i &lt; versions.length; i++) {
      let left = result.map(function (l) {
        return l.line;
      });
      const currentVersion = versions[i];

      let right = currentVersion[key];
      if (ignoreWhiteSpace)
        right = right.map(function (line) {
          return line.replace(/\s\s+/g, " ").trim();
        });

      let changes = patienceDiff(left, right, true);

      result = changes.lines
        .filter(function removeDeletion(diff) {
          return diff.bIndex !== -1;
        })
        .map(function (diff) {
          let resultIndex = diff.aIndex;
          let date = new Date(
            resultIndex === -1
              ? currentVersion.sys_updated_on
              : result[resultIndex].date
          );
          return {
            index: diff.bIndex,
            line: diff.line,
            author:
              resultIndex === -1
                ? currentVersion.sys_updated_by
                : result[resultIndex].author,
            versionID:
              resultIndex === -1
                ? currentVersion.sys_id
                : result[resultIndex].versionID,
            source:
              resultIndex === -1
                ? currentVersion.source
                : result[resultIndex].source,
            date: date.valueOf(),
          };
        });
    }

    return result.map(function (diff, index) {
      let res = {
        onlyWhiteSpace: diff.line.trim().length === 0,
        index: diff.index + 1,
        author: diff.author,
        versionID: diff.versionID,
        source: diff.source,
        date: diff.date,
        line: diff.line,
        sourceName: (diff.source.display_value || "[SN BLAME] Deleted").replace(
          "Update Set: ",
          ""
        ),
        updateSetNotFound: !diff.source.display_value,
      };

      return res;
    });
  }

  /**
   * Compares the calculated blame with the current changes to hide the line if the line was updated with local changes
   *
   * @param {Array&lt;string>} newModelValue Array of the lines with current value of the field
   * @param {Array&lt;BlameLine>} serverValue Array of lines with the infromation of the last user/update set/patch who changed the line
   * @param {boolean} ignoreWhiteSpace if true will ignore whitespaces when comparing lines
   * @returns {Array&lt;BlameLine>} Array of lines with the infromation of the last user/update set/patch who changed the line
   */
  function getDiffsWithCurrent(newModelValue, serverValue, ignoreWhiteSpace) {
    var changes = patienceDiff(
      serverValue.map(function (diff) {
        if (ignoreWhiteSpace) return diff.line.replace(/\s\s+/g, " ").trim();
        return diff.line;
      }),
      ignoreWhiteSpace
        ? newModelValue.map(function (line) {
            return line.replace(/\s\s+/g, " ").trim();
          })
        : newModelValue,
      true
    );

    changes = changes.lines
      .filter(function removeDeletion(diff) {
        return diff.bIndex !== -1;
      })
      .map(function (diff) {
        let resultIndex = diff.aIndex;
        let result = {
          onlyWhiteSpace: diff.line.trim().length === 0,
          index: diff.bIndex + 1,
          line: diff.line,
          newModel: resultIndex === -1,
        };

        if (resultIndex !== -1) {
          result.author = serverValue[resultIndex].author;
          result.versionID = serverValue[resultIndex].versionID;
          result.source = serverValue[resultIndex].source;
          result.sourceName = serverValue[resultIndex].sourceName;
          result.date = serverValue[resultIndex].date;
        }

        return result;
      });

    return changes;
  }

  async function  triggerScriptAnalysisEvent(scriptIncludeObject, currentScope){
    window.dispatchEvent(
      new CustomEvent("sn-load-library", {
        detail: {
          libs: scriptIncludeObject.libs,
        },
      })
    );

    scriptIncludeObject.scriptExtends.filter(e=>e).forEach(async (className) =>
      await staticCodeAnalisisUtil.triggerScriptIncludeLib(
        [staticCodeAnalisisUtil.getScriptIncludeSysID(className)],
        className.split(".")[1] ? className.split(".")[0] : currentScope,
        restFactory,
        triggerScriptAnalysisEvent
      )
    );
  }

  /**
   * finds script inclulde calls only on the current script (accepts malformed scripts) will add intelisense for the found script includes.
   * @param {string} scriptString script to parse and find script include calls
   * @param {string} scope current scope
   */
  async function findScriptIncludeCall(scriptString, scope) {
    let scriptIncludeCalls = staticCodeAnalisisUtil.findScriptIncludeCall(
      scriptString,
      scope
    );

    if(!scriptIncludeCalls || scriptIncludeCalls.length === 0)
      return;

    let scriptIDList = scriptIncludeCalls
      .filter((script,index,arr) => arr.findIndex(s=> s.scriptInclude === script.scriptInclude) === index)
      .map(identifier => staticCodeAnalisisUtil.getScriptIncludeSysID(identifier.scriptInclude))
      .filter(s=>!!s);

    await staticCodeAnalisisUtil.triggerScriptIncludeLib(scriptIDList, scope, restFactory, triggerScriptAnalysisEvent);
  }
}
</code></pre>
        </article>
      </section>
    </div>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Tue Sep 09
      2025 00:48:07 GMT+0200 (hora de verano de Europa central) using the
      <a href="https://github.com/clenemt/docdash">docdash</a> theme.
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/polyfill.js"></script>
    <script src="scripts/linenumber.js"></script>

    <script src="scripts/search.js" defer></script>
  </body>
</html>
