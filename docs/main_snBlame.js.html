<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>main/snBlame.js - SN Blame</title>

    <meta
      name="description"
      content="ServiceNow Browser Extensions utility tool"
    />

    <meta name="keywords" content="ServiceNow" />
    <meta name="keyword" content="ServiceNow" />

    <meta property="og:title" content="SN Blame" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="" />
    <meta property="og:site_name" content="SN Blame" />
    <meta property="og:url" content="" />

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css" />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css" />
    <script src="scripts/nav.js" defer></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <input type="checkbox" id="nav-trigger" class="nav-trigger" />
    <label for="nav-trigger" class="navicon-button x">
      <div class="navicon"></div>
    </label>

    <label for="nav-trigger" class="overlay"></label>

    <nav>
      <input type="text" id="nav-search" placeholder="Search" />

      <h2><a href="index.html">Home</a></h2>
      <h2>
        <a
          href="https://github.com/amagnin/SNBlameExtension"
          target="_blank"
          class="menu-item"
          id="repository"
          >Github repo</a
        >
      </h2>
      <h3>Classes</h3>
      <ul>
        <li>
          <a href="StaticCodeAnalisisUtil.html">StaticCodeAnalisisUtil</a>
          <ul class="methods">
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#updateCache">updateCache</a>
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#getScriptCacheSysID"
                >getScriptCacheSysID</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#getLoadedLibraries"
                >getLoadedLibraries</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#getScriptIncludeParsedCache"
                >getScriptIncludeParsedCache</a
              >
            </li>
            <li data-type="method">
              <a
                href="StaticCodeAnalisisUtil.html#updateScriptIncludeParsedCache"
                >updateScriptIncludeParsedCache</a
              >
            </li>
            <li data-type="method">
              <a
                href="StaticCodeAnalisisUtil.html#runScriptIncludesCodeAnalisis"
                >runScriptIncludesCodeAnalisis</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#runScriptAnalisis"
                >runScriptAnalisis</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#findScriptIncludeCall"
                >findScriptIncludeCall</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#setAvailableSNScopes"
                >setAvailableSNScopes</a
              >
            </li>
            <li data-type="method">
              <a href="StaticCodeAnalisisUtil.html#getScopeFromID"
                >getScopeFromID</a
              >
            </li>
          </ul>
        </li>
        <li>
          <a href="MonacoBlameColorMap.html">MonacoBlameColorMap</a>
          <ul class="methods">
            <li data-type="method">
              <a href="MonacoBlameColorMap.html#getColor">getColor</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="MonacoBlameGutter.html">MonacoBlameGutter</a>
          <ul class="methods">
            <li data-type="method">
              <a href="MonacoBlameGutter.html#createGutter">createGutter</a>
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutter.html#updateLines">updateLines</a>
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutter.html#updateGutterSize"
                >updateGutterSize</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutter.html#updateGutter">updateGutter</a>
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutter.html#destroyGutter">destroyGutter</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="MonacoBlameGutterWrapper.html">MonacoBlameGutterWrapper</a>
          <ul class="methods">
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#createGutter"
                >createGutter</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#updateGutter"
                >updateGutter</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#updateGutterLines"
                >updateGutterLines</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#updateGutterSize"
                >updateGutterSize</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#destroyGutter"
                >destroyGutter</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#updateGutterOptions"
                >updateGutterOptions</a
              >
            </li>
            <li data-type="method">
              <a href="MonacoBlameGutterWrapper.html#gutterExists"
                >gutterExists</a
              >
            </li>
          </ul>
        </li>
        <li>
          <a href="SNBlameOptions.html">SNBlameOptions</a>
          <ul class="methods">
            <li data-type="method">
              <a href="SNBlameOptions.html#reloadOptions">reloadOptions</a>
            </li>
            <li data-type="method">
              <a href="SNBlameOptions.html#getOption">getOption</a>
            </li>
            <li data-type="method">
              <a href="SNBlameOptions.html#setOption">setOption</a>
            </li>
            <li data-type="method">
              <a href="SNBlameOptions.html#getAllOptions">getAllOptions</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="snRESTFactory.html">snRESTFactory</a>
          <ul class="methods">
            <li data-type="method">
              <a href="snRESTFactory.html#~getVersions">getVersions</a>
            </li>
            <li data-type="method">
              <a href="snRESTFactory.html#~getScriptIncludes"
                >getScriptIncludes</a
              >
            </li>
            <li data-type="method">
              <a href="snRESTFactory.html#~getRecords">getRecords</a>
            </li>
            <li data-type="method">
              <a href="snRESTFactory.html#~getScope">getScope</a>
            </li>
            <li data-type="method">
              <a href="snRESTFactory.html#~getProperties">getProperties</a>
            </li>
            <li data-type="method">
              <a href="snRESTFactory.html#~getScriptIncludeCache"
                >getScriptIncludeCache</a
              >
            </li>
          </ul>
        </li>
        <li>
          <a href="SNBlameDateUtils.html">SNBlameDateUtils</a>
          <ul class="methods">
            <li data-type="method">
              <a href="SNBlameDateUtils.html#.getFormattedDate"
                >getFormattedDate</a
              >
            </li>
            <li data-type="method">
              <a href="SNBlameDateUtils.html#.timeAgo">timeAgo</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="SNBlamePlaceholderContentWidget.html"
            >SNBlamePlaceholderContentWidget</a
          >
          <ul class="methods">
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#updateDiff"
                >updateDiff</a
              >
            </li>
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#onCursorChange"
                >onCursorChange</a
              >
            </li>
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#getId">getId</a>
            </li>
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#getDomNode"
                >getDomNode</a
              >
            </li>
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#getPosition"
                >getPosition</a
              >
            </li>
            <li data-type="method">
              <a href="SNBlamePlaceholderContentWidget.html#dispose">dispose</a>
            </li>
          </ul>
        </li>
      </ul>
      <h3>Modules</h3>
      <ul>
        <li>
          <a href="module-scriptIncludesStaticCodeAnalysis.html"
            >scriptIncludesStaticCodeAnalysis</a
          >
          <ul class="methods">
            <li data-type="method">
              <a
                href="module-scriptIncludesStaticCodeAnalysis.html#~getSNClassMethods"
                >getSNClassMethods</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-scriptIncludesStaticCodeAnalysis.html#~getTableName"
                >getTableName</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-scriptIncludesStaticCodeAnalysis.html#~runScriptIncludesCodeAnalisis"
                >runScriptIncludesCodeAnalisis</a
              >
            </li>
          </ul>
        </li>
        <li>
          <a href="module-scriptIncludesToExtraLib.html"
            >scriptIncludesToExtraLib</a
          >
          <ul class="methods">
            <li data-type="method">
              <a
                href="module-scriptIncludesToExtraLib.html#~getScriptIncludeLib"
                >getScriptIncludeLib</a
              >
            </li>
          </ul>
        </li>
        <li>
          <a href="module-walkerFunctions.html">walkerFunctions</a>
          <ul class="methods">
            <li data-type="method">
              <a href="module-walkerFunctions.html#~isGlideRecordNext"
                >isGlideRecordNext</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-walkerFunctions.html#~getConstructorContextExpresions"
                >getConstructorContextExpresions</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-walkerFunctions.html#~getGlideRecordFromDeclaration"
                >getGlideRecordFromDeclaration</a
              >
            </li>
            <li data-type="method">
              <a
                href="module-walkerFunctions.html#~getGlideRecordFromAssignment"
                >getGlideRecordFromAssignment</a
              >
            </li>
            <li data-type="method">
              <a href="module-walkerFunctions.html#~checkNestedWhileRecord"
                >checkNestedWhileRecord</a
              >
            </li>
            <li data-type="method">
              <a href="module-walkerFunctions.html#~removeParentesis"
                >removeParentesis</a
              >
            </li>
          </ul>
        </li>
        <li><a href="module-SNBlameMain.html">SNBlameMain</a></li>
      </ul>
      <h3>Global</h3>
      <ul>
        <li><a href="global.html#BlameLine">BlameLine</a></li>
        <li><a href="global.html#BlameOptions">BlameOptions</a></li>
        <li><a href="global.html#snVersions">snVersions</a></li>
        <li>
          <a href="global.html#ServiceNowRESTFactory">ServiceNowRESTFactory</a>
        </li>
        <li><a href="global.html#MonacoEditor">MonacoEditor</a></li>
      </ul>
    </nav>

    <div id="main">
      <h1 class="page-title">main/snBlame.js</h1>

      <section>
        <article>
          <pre
            class="prettyprint source linenums"
          ><code>import SNBlamePlaceholderContentWidget from "./SNBlamePlaceholderContentWidget.js";


export default function snBlamebootstrap(){
  /**
   * @typedef MonacoEditor
   * @type {object}
   * @see {@link https://microsoft.github.io/monaco-editor/typedoc/modules/editor.html}
   */

  const snBlameOptions = {
    useExtensionIntelisense: true,
  }

  /**
   * triggers the Blame part of the extension if the monaco global object is available on the page
   * 
   * @param {Object} monaco ServiceNow global monaco object
   * 
   */
  const snBlamebootstrap = (monaco) => {
    if (!monaco || typeof monaco?.editor?.getEditors !== 'function') return;

    let fields = {};

    let originalMonacoIntelisense = GlideEditorMonaco.prototype.addIntellisenseforScriptInclude;
    GlideEditorMonaco.prototype.addIntellisenseforScriptInclude = function(){
      if(snBlameOptions.useExtensionIntelisense) return;

      originalMonacoIntelisense.apply(this, arguments);
    }

    const fullScriptIntelisense = function(editor, field){
      window.dispatchEvent(
        new CustomEvent("sn-check-full-script",{
          detail: {
            script: editor.getValue(),
            field,
            currentScope: g_scratchpad?.scope,
          },
        })
      )
    };

    monaco.editor.getEditors().forEach((editor) => {
      let f = editor
        .getContainerDomNode()
        .siblings()
        .find(function (e) {
          return e.tagName.toUpperCase() === "TEXTAREA";
        })
        .id.split(".");

      let field = f[f.length - 1];

      fields[field] = {
        lines: editor.getValue().split("\n"),
        id: f.join("."),
      };

      editor.addAction({
        id: "show-sn-blame-user",
        label: "SNBlame: Toggle User/Update set",

        keybindings: [
          monaco.KeyMod.CtrlCmd | monaco.KeyCode.F10,
          monaco.KeyMod.chord(monaco.KeyMod.CtrlCmd | monaco.KeyCode.F10),
        ],

        precondition: null,
        keybindingContext: null,
        contextMenuGroupId: "navigation",
        contextMenuOrder: 1.5,
        run: function (ed) {
          window.dispatchEvent(
            new CustomEvent("sn-blame-toggle-user-update-set")
          );
        },
      });

      editor.addAction({
        id: "show-sn-blame-gutter-date",
        label: "SNBlame: Toggle gutter date",

        keybindings: [
          monaco.KeyMod.CtrlCmd | monaco.KeyCode.F9,
          monaco.KeyMod.chord(monaco.KeyMod.CtrlCmd | monaco.KeyCode.F9),
        ],

        precondition: null,
        keybindingContext: null,
        contextMenuGroupId: "navigation",
        contextMenuOrder: 1.5,
        run: function (ed) {
          window.dispatchEvent(new CustomEvent("sn-blame-toggle-gutter-date"));
        },
      });

      editor.addAction({
        id: "show-sn-blame-whitespace",
        label: "SNBlame: Toggle whitespace",

        precondition: null,
        keybindingContext: null,
        contextMenuGroupId: "navigation",
        contextMenuOrder: 1.5,
        run: function (ed) {
          window.dispatchEvent(new CustomEvent("sn-blame-toggle-whitespace"));
        },
      });

      editor.addAction({
        id: "debug-sn-blame-line-numbers",
        label: "SNBlame: Toggle line numbers",

        keybindings: [
          monaco.KeyMod.CtrlCmd | monaco.KeyCode.F8,
          monaco.KeyMod.chord(monaco.KeyMod.CtrlCmd | monaco.KeyCode.F8),
        ],

        precondition: null,
        keybindingContext: null,
        contextMenuGroupId: "navigation",
        contextMenuOrder: 1.5,
        run: function (ed) {
          window.dispatchEvent(new CustomEvent("sn-blame-toggle-line-numbers"));
        },
      });

      /** Mutation observer on the monaco gutter is smoother than the editor.onDidScrollChange **/
      let scrollObserver = new MutationObserver(() => {
        let scroll = {
          scrollHeight: editor.getScrollHeight(),
          scrollTop: editor.getScrollTop(),
        };
        window.dispatchEvent(
          new CustomEvent("sn-blame-scroll", { detail: { scroll, field } })
        );
      });

      let editorElement = document.querySelector(
        `[id='element.${fields[field].id}'] #debugContainer`
      );

      scrollObserver.observe(
        editorElement.querySelector(".margin-view-overlays"),
        {
          childList: true,
          subtree: true,
        }
      );

      let model = editor.getModel();
      let updatedLines = [];
      let debounceTimer;

      let monacoDebounce = function(func, timeout = 300){
        return (...args) => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
      }

      editor.onDidChangeModelContent(function(event) {
        window.dispatchEvent(
          new CustomEvent("sn-blame-model-change", {
            detail: {
              script: editor.getValue(),
              field,
            },
          })
        );

        if(!snBlameOptions.useExtensionIntelisense) return
        
        updatedLines = updatedLines.concat(event.changes.reduce((acc, ch)=> {
          let lineRange =  ch.range.endLineNumber - ch.range.startLineNumber;
          if(lineRange >= 0){
            let count = ch.range.startLineNumber
            while(count &lt;= ch.range.endLineNumber){
              acc.push(count)
              count ++
            }
          }
          return acc;
        }, [])).filter((e,i,arr) => arr.indexOf(e) === i);
        
        monacoDebounce(function(){
          let lines = updatedLines.map(lineNumber => model.getLineContent(lineNumber));

          window.dispatchEvent(
            new CustomEvent("sn-check-lines",{
              detail: {
                lines: lines,
                field,
                currentScope: g_scratchpad?.scope,
              },
            })
          )

          updatedLines = [];
        }, 500)();      

        
      });

      let placeholderContentWidget = new SNBlamePlaceholderContentWidget(editor);
      window.addEventListener("sn-blame-diff-update", function (event) {
        if (event.detail.field !== field) return;

        let diff = event.detail.diff;

        placeholderContentWidget.updateDiff(diff);
        placeholderContentWidget.onCursorChange();
      });

      window.addEventListener("sn-blame-get-scroll-position", (event) => {
        if (event.detail.field !== field) return;
        let scroll = {
          scrollHeight: editor.getScrollHeight(),
          scrollTop: editor.getScrollTop(),
        };
    
        window.dispatchEvent(
          new CustomEvent("sn-blame-scroll", { detail: { scroll, field } })
        );
      });

      window.addEventListener("sn-blame-trigger-full-script-intelisense", function (event) {
        if(snBlameOptions.useExtensionIntelisense)
          fullScriptIntelisense(editor, field);
      });

    });

    window.dispatchEvent(
      new CustomEvent("sn-blame-init", {
        detail: {
          fields: fields,
          g_ck,
          table: g_form.getTableName(),
          sys_id: g_form.getUniqueValue(),
        },
      })
    );

    window.addEventListener("sn-load-library", (event) => {
      const { libs } = event.detail;
      libs.forEach((lib)=> monaco.languages.typescript.javascriptDefaults.addExtraLib(lib));
    })

    
  };

  window.addEventListener("sn-blame-start", () => {
    if (typeof monaco !== "undefined") snBlamebootstrap(monaco);
  });
};</code></pre>
        </article>
      </section>
    </div>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Sun Feb 23
      2025 22:45:59 GMT+0100 (hora estándar de Europa central) using the
      <a href="https://github.com/clenemt/docdash">docdash</a> theme.
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/polyfill.js"></script>
    <script src="scripts/linenumber.js"></script>

    <script src="scripts/search.js" defer></script>
  </body>
</html>
